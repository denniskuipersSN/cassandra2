# Starter pipeline 
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- none

variables:

  ### Variables ###
  serviceNamespace: $(SERVICE_NAMESPACE)
  repoPrefix: '$(REPO_PREFIX)'

pool:
  vmImage: ubuntu-latest

stages:  
  #### Deploy All Images Stagee ####
  - stage: Deploy_All_Images
    jobs:
      - job: Deploy_All_Images
        steps:
          - task: InvokeRESTAPI@1
            inputs:
              connectionType: 'connectedServiceName'
              serviceConnection: 'ServiceNow Loomsales demo for Schweiz'
              method: 'POST'
              body: |
                { 
                   "buildNumber": "$(build.buildId)",
                   "isMultiBranch": "true",
                   "branchName": "$(build.sourceBranchName)"
                }
              waitForCompletion: 'true'        
          - task: HelmDeploy@2
            displayName: 'Deploying All Images'
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceConnection: 'olympus'
              chartName: 'boutique'
              releaseName: 'boutique'
              chartType: FilePath
              chartPath: helm
              command: 'upgrade'
              force: true
              namespace: $(serviceNamespace)
              arguments: --set imageRepo=$(repoPrefix)
